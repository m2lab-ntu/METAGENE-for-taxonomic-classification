# MetaClassifier é…ç½®ä¿®æ”¹æŒ‡å— (Configuration Guide)

## ğŸ“Œ éœ€è¦ä¿®æ”¹çš„åœ°æ–¹ (What You Need to Change)

### 1ï¸âƒ£ **é¸æ“‡é…ç½®æ–‡ä»¶ (Choose Config File)**

æ ¹æ“šæ‚¨çš„éœ€æ±‚é¸æ“‡ä¸€å€‹é…ç½®æ–‡ä»¶ï¼š

```bash
metaclassifier/configs/
â”œâ”€â”€ metagene_bpe.yaml      # ä½¿ç”¨ METAGENE-1 + BPE tokenizer (æ¨è–¦)
â”œâ”€â”€ dnabert_kmer.yaml      # ä½¿ç”¨ DNABERT-2 + k-mer tokenizer
â””â”€â”€ evo2_nucleotide.yaml   # ä½¿ç”¨ Evo2 + å–®æ ¸è‹·é…¸ tokenizer
```

**å»ºè­°ï¼šå¾ `metagene_bpe.yaml` é–‹å§‹**

---

### 2ï¸âƒ£ **å¿…é ˆä¿®æ”¹çš„åƒæ•¸ (Required Changes)**

#### A. **æ•¸æ“šè·¯å¾‘ (Data Paths)** âš ï¸ **å¿…é ˆè¨­å®š**

ç·¨è¼¯é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ æˆ–ä¿®æ”¹ä»¥ä¸‹éƒ¨åˆ†ï¼š

```yaml
# Dataset configuration
dataset:
  train_fasta: /media/user/disk2/full_labeled_species_train_reads_shuffled  # æ‚¨çš„è¨“ç·´æ•¸æ“šè·¯å¾‘
  val_fasta: /media/user/disk2/full_labeled_species_val_reads_shuffled      # æ‚¨çš„é©—è­‰æ•¸æ“šè·¯å¾‘
  mapping_tsv: /media/user/disk2/MetaTransformer_new_pipeline/myScript/all_available_species_mapping.tab  # æ¨™ç±¤æ˜ å°„æ–‡ä»¶
  
  # Header format (æ ¹æ“šæ‚¨çš„æ•¸æ“šæ ¼å¼èª¿æ•´)
  header_regex: "^lbl\\|(?P<class_id>\\d+)\\|(?P<tax_id>\\d+)?\\|(?P<readlen>\\d+)?\\|(?P<name>[^/\\s]+)(?:/(?P<mate>\\d+))?$"
  
  # Column names in mapping file
  class_column: class_id      # é¡åˆ¥ ID çš„åˆ—å
  label_column: label_name    # æ¨™ç±¤åç¨±çš„åˆ—å
  tax_column: tax_id         # åˆ†é¡ ID çš„åˆ—åï¼ˆå¯é¸ï¼‰
```

#### B. **è¼¸å‡ºç›®éŒ„ (Output Directory)**

```yaml
training:
  output_dir: outputs/my_metagene_training  # ä¿®æ”¹ç‚ºæ‚¨æƒ³è¦çš„è¼¸å‡ºè·¯å¾‘
```

---

### 3ï¸âƒ£ **å¯é¸ä¿®æ”¹çš„åƒæ•¸ (Optional Changes)**

#### C. **åºåˆ—é•·åº¦ (Sequence Length)**

æ ¹æ“šæ‚¨çš„è®€é•·èª¿æ•´ï¼š

```yaml
tokenizer:
  max_length: 192  # 150bp è®€é•·æ¨è–¦ 192
                   # å¦‚æœæ˜¯ 300bp è®€é•·ï¼Œå¯ä»¥ç”¨ 384 æˆ– 512
```

**åƒè€ƒï¼š**
- 150bp è®€é•·ï¼š`max_length: 192` (æ¨è–¦)
- 250bp è®€é•·ï¼š`max_length: 384`
- é•·è®€é•· (>400bp)ï¼š`max_length: 512`

#### D. **è¨“ç·´é€Ÿåº¦ vs ç²¾åº¦ (Speed vs Accuracy)**

**å¿«é€Ÿè¨“ç·´ï¼ˆè¼ƒä½ç²¾åº¦ï¼‰ï¼š**
```yaml
tokenizer:
  max_length: 128         # æ›´çŸ­çš„åºåˆ—

encoder:
  lora:
    enabled: true
    r: 4                  # è¼ƒå°çš„ LoRA rank
    alpha: 8

training:
  batch_size: 2           # æ›´å¤§çš„ batch
  grad_accum_steps: 4     # è¼ƒå°‘çš„ç´¯ç©æ­¥æ•¸
  max_epochs: 3           # è¼ƒå°‘çš„ epoch
```

**é«˜ç²¾åº¦è¨“ç·´ï¼ˆè¼ƒæ…¢ï¼‰ï¼š**
```yaml
tokenizer:
  max_length: 192         # å®Œæ•´åºåˆ—

encoder:
  lora:
    enabled: true
    r: 8                  # æ›´å¤§çš„ LoRA rank
    alpha: 16

training:
  batch_size: 1           # å° batch æ›´ç²¾ç¢º
  grad_accum_steps: 8     # æ›´å¤šç´¯ç©æ­¥æ•¸
  max_epochs: 10          # æ›´å¤š epoch
```

#### E. **GPU å…§å­˜å„ªåŒ– (GPU Memory)**

å¦‚æœé‡åˆ° OOM (Out of Memory)ï¼š

```yaml
encoder:
  gradient_checkpointing: true  # å•Ÿç”¨æ¢¯åº¦æª¢æŸ¥é»ï¼ˆç¯€çœå…§å­˜ï¼‰

training:
  batch_size: 1           # æ¸›å° batch size
  grad_accum_steps: 16    # å¢åŠ æ¢¯åº¦ç´¯ç©
  precision: bf16-mixed   # ä½¿ç”¨æ··åˆç²¾åº¦
```

#### F. **å­¸ç¿’ç‡å’Œå„ªåŒ–å™¨ (Learning Rate)**

```yaml
training:
  lr: 0.0002              # é è¨­å­¸ç¿’ç‡
                          # METAGENE-1: 0.0002 (æ¨è–¦)
                          # DNABERT: 0.0001
                          # Evo2: 0.00005

optimizer:
  name: adamw
  weight_decay: 0.01
  betas: [0.9, 0.999]
```

#### G. **æ—©åœ (Early Stopping)**

```yaml
training:
  early_stopping:
    patience: 2           # é©—è­‰æŒ‡æ¨™ä¸æ”¹å–„å¤šå°‘å€‹ epoch å¾Œåœæ­¢
    metric: macro_f1      # ç›£æ§çš„æŒ‡æ¨™
    mode: max             # max (è¶Šå¤§è¶Šå¥½) æˆ– min (è¶Šå°è¶Šå¥½)
```

---

### 4ï¸âƒ£ **Tokenizer é¸æ“‡ (Tokenizer Choice)**

æ ¹æ“šæ‚¨çš„æ¨¡å‹é¸æ“‡ï¼š

#### **BPE Tokenizer (METAGENE-1)** âœ… æ¨è–¦
```yaml
tokenizer:
  type: bpe
  path: "metagene-ai/METAGENE-1"
  max_length: 192
```

#### **K-mer Tokenizer (DNABERT)**
```yaml
tokenizer:
  type: kmer
  k: 6                    # k-mer é•·åº¦
  overlap: true           # æ˜¯å¦é‡ç–Š
  max_length: 512
```

#### **Single-Nucleotide Tokenizer (Evo2)**
```yaml
tokenizer:
  type: evo2
  max_length: 1024        # Evo2 æ”¯æŒæ›´é•·çš„åºåˆ—
```

---

### 5ï¸âƒ£ **Encoder é¸æ“‡ (Encoder Choice)**

#### **METAGENE-1** âœ… æ¨è–¦
```yaml
encoder:
  type: metagene
  path: "metagene-ai/METAGENE-1"
  freeze: false           # false = å¾®èª¿ï¼Œtrue = åƒ…ç‰¹å¾µæå–
```

#### **DNABERT-2**
```yaml
encoder:
  type: dnabert
  path: "zhihan1996/DNABERT-2-117M"
  freeze: false
```

#### **Evo2** (éœ€è¦å…ˆå®‰è£)
```yaml
encoder:
  type: evo2
  path: "evo2_7b"         # é¸é …: evo2_7b, evo2_40b, evo2_1b_base
  freeze: true            # Evo2 è¼ƒå¤§ï¼Œå»ºè­°å‡çµåšç‰¹å¾µæå–
```

---

### 6ï¸âƒ£ **Classifier Head é¸æ“‡**

#### **Linear (ç°¡å–®å¿«é€Ÿ)** âœ… æ¨è–¦é–‹å§‹æ™‚ä½¿ç”¨
```yaml
model:
  pooling: mean
  classifier_type: linear
  classifier_config:
    dropout: 0.1
```

#### **Transformer (æ›´è¤‡é›œï¼Œå¯èƒ½æ›´æº–ç¢º)**
```yaml
model:
  pooling: mean
  classifier_type: transformer
  classifier_config:
    num_layers: 2
    num_heads: 8
    dim_feedforward: 2048
    dropout: 0.1
```

---

## ğŸš€ ä½¿ç”¨æµç¨‹ (Usage Workflow)

### **è¨“ç·´ (Training)**

```bash
cd /media/user/disk2/METAGENE/classification/metaclassifier

# æ¿€æ´»ç’°å¢ƒ
source /home/user/anaconda3/bin/activate METAGENE

# è¨“ç·´
python train.py \
  --config configs/metagene_bpe.yaml \
  --train_fasta /path/to/train.fasta \
  --val_fasta /path/to/val.fasta \
  --mapping_tsv /path/to/mapping.tsv \
  --output_dir outputs/my_training
```

### **é æ¸¬ (Prediction)**

```bash
# å–®è®€é æ¸¬
python predict.py \
  --config configs/metagene_bpe.yaml \
  --checkpoint outputs/my_training/checkpoints/best.pt \
  --input /path/to/reads.fasta \
  --output predictions.csv

# å¸¶æ¨£æœ¬èšåˆçš„é æ¸¬
python predict.py \
  --config configs/metagene_bpe.yaml \
  --checkpoint outputs/my_training/checkpoints/best.pt \
  --input /path/to/reads.fasta \
  --output predictions.csv \
  --aggregate \
  --abundance_output abundance.csv \
  --confidence_threshold 0.7
```

---

## ğŸ“Š é—œéµåƒæ•¸é€ŸæŸ¥è¡¨ (Quick Reference)

| åƒæ•¸ | ä½œç”¨ | æ¨è–¦å€¼ | å‚™è¨» |
|------|------|--------|------|
| `max_length` | åºåˆ—æœ€å¤§é•·åº¦ | 192 | 150bp è®€é•· |
| `batch_size` | æ‰¹æ¬¡å¤§å° | 1-2 | è¶Šå¤§è¶Šå¿«ï¼Œè¶Šå°è¶Šç©©å®š |
| `grad_accum_steps` | æ¢¯åº¦ç´¯ç© | 4-8 | æ¨¡æ“¬æ›´å¤§çš„ batch |
| `lr` | å­¸ç¿’ç‡ | 0.0002 | METAGENE-1 æ¨è–¦ |
| `max_epochs` | æœ€å¤§ epoch æ•¸ | 3-10 | å¿«é€Ÿè¨“ç·´ç”¨ 3ï¼Œå®Œæ•´è¨“ç·´ç”¨ 10 |
| `patience` | æ—©åœè€å¿ƒ | 2-3 | é©—è­‰ä¸æ”¹å–„å¹¾æ¬¡å¾Œåœæ­¢ |
| `lora.r` | LoRA rank | 4-8 | è¶Šå¤§è¶Šæº–ç¢ºä½†è¶Šæ…¢ |

---

## âš ï¸ å¸¸è¦‹å•é¡Œ (Common Issues)

### **å•é¡Œ 1: OOM (GPU å…§å­˜ä¸è¶³)**

**è§£æ±ºæ–¹æ¡ˆï¼š**
```yaml
encoder:
  gradient_checkpointing: true

training:
  batch_size: 1
  grad_accum_steps: 16
```

### **å•é¡Œ 2: è¨“ç·´å¤ªæ…¢**

**è§£æ±ºæ–¹æ¡ˆï¼š**
```yaml
tokenizer:
  max_length: 128        # ç¸®çŸ­åºåˆ—

training:
  batch_size: 2          # å¢å¤§ batch
  grad_accum_steps: 4    # æ¸›å°‘ç´¯ç©
  max_epochs: 3          # æ¸›å°‘ epoch
```

### **å•é¡Œ 3: Header Regex ä¸åŒ¹é…**

æª¢æŸ¥æ‚¨çš„ FASTA header æ ¼å¼ï¼Œä¿®æ”¹ `header_regex`ï¼š

```yaml
# å¦‚æœæ‚¨çš„ header æ ¼å¼æ˜¯: >seq_001|species_name
header_regex: "^(?P<seq_id>[^|]+)\\|(?P<label_name>.+)$"
```

---

## ğŸ“š æ›´å¤šè³‡æº

- **å®Œæ•´æ¶æ§‹èªªæ˜**: `ARCHITECTURE.md`
- **é·ç§»æŒ‡å—**: `MIGRATION_GUIDE.md`
- **Evo2 ä½¿ç”¨**: `USING_EVO2.md`
- **ç¯„ä¾‹è…³æœ¬**: `examples/`

---

## ğŸ’¡ å»ºè­°èµ·å§‹é…ç½® (Recommended Starting Config)

```yaml
# é‡å°æ‚¨çš„æ•¸æ“šçš„å»ºè­°é…ç½®
tokenizer:
  type: bpe
  path: "metagene-ai/METAGENE-1"
  max_length: 192        # 150bp è®€é•·æœ€ä½³

encoder:
  type: metagene
  path: "metagene-ai/METAGENE-1"
  freeze: false
  lora:
    enabled: true
    r: 4
    alpha: 8
    dropout: 0.05
    target_modules: [q_proj, v_proj]
  gradient_checkpointing: true

model:
  pooling: mean
  classifier_type: linear
  classifier_config:
    dropout: 0.1

training:
  batch_size: 1
  grad_accum_steps: 8
  max_epochs: 5
  lr: 0.0002
  weight_decay: 0.01
  early_stopping:
    patience: 2
    metric: macro_f1

dataset:
  train_fasta: /media/user/disk2/full_labeled_species_train_reads_shuffled
  val_fasta: /media/user/disk2/full_labeled_species_val_reads_shuffled
  mapping_tsv: /media/user/disk2/MetaTransformer_new_pipeline/myScript/all_available_species_mapping.tab
  header_regex: "^lbl\\|(?P<class_id>\\d+)\\|(?P<tax_id>\\d+)?\\|(?P<readlen>\\d+)?\\|(?P<name>[^/\\s]+)(?:/(?P<mate>\\d+))?$"
  class_column: class_id
  label_column: label_name
```

é€™å€‹é…ç½®å¹³è¡¡äº†é€Ÿåº¦å’Œç²¾åº¦ï¼Œé©åˆåˆæ¬¡ä½¿ç”¨ã€‚

