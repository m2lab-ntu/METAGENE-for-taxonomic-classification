# ç¾æœ‰ç³»çµ± vs MetaClassifier å°æ¯” (Current System vs MetaClassifier)

## ğŸ“Š ç³»çµ±æ¶æ§‹å°æ¯”

### **ç¾æœ‰ç³»çµ± (Current System)**

```
classification/
â”œâ”€â”€ train.py              â† å–®ä¸€è¨“ç·´è…³æœ¬ï¼ˆé›£ä»¥æ“´å±•ï¼‰
â”œâ”€â”€ predict.py            â† å–®ä¸€é æ¸¬è…³æœ¬
â”œâ”€â”€ configs/
â”‚   â””â”€â”€ default.yaml      â† å–®ä¸€é…ç½®æ–‡ä»¶
â””â”€â”€ modules/
    â”œâ”€â”€ dataloading.py    â† æ•¸æ“šè¼‰å…¥
    â”œâ”€â”€ modeling.py       â† æ¨¡å‹å®šç¾©ï¼ˆå¯«æ­»åœ¨ä»£ç¢¼ä¸­ï¼‰
    â””â”€â”€ utils.py
```

**é™åˆ¶ï¼š**
- âŒ æ¨¡å‹æ¶æ§‹å¯«æ­»åœ¨ä»£ç¢¼ä¸­
- âŒ è¦æ› tokenizer éœ€è¦æ”¹ä»£ç¢¼
- âŒ è¦æ› encoder éœ€è¦æ”¹ä»£ç¢¼
- âŒ ç„¡æ³•è¼•æ˜“æ·»åŠ æ–°çš„åˆ†é¡å™¨
- âŒ æ²’æœ‰æ¨£æœ¬å±¤ç´šèšåˆåŠŸèƒ½

---

### **MetaClassifier (æ–°ç³»çµ±)**

```
metaclassifier/
â”œâ”€â”€ tokenization/         â† æ¨¡å¡ŠåŒ– tokenizer
â”‚   â”œâ”€â”€ bpe_tokenizer.py      (METAGENE-1)
â”‚   â”œâ”€â”€ kmer_tokenizer.py     (DNABERT)
â”‚   â””â”€â”€ evo2_tokenizer.py     (Evo2)
â”‚
â”œâ”€â”€ embedding/            â† æ¨¡å¡ŠåŒ– encoder
â”‚   â”œâ”€â”€ metagene_encoder.py   (METAGENE-1)
â”‚   â”œâ”€â”€ dnabert_encoder.py    (DNABERT-2)
â”‚   â””â”€â”€ evo2_encoder.py       (Evo2)
â”‚
â”œâ”€â”€ model/                â† æ¨¡å¡ŠåŒ– classifier
â”‚   â”œâ”€â”€ pooling.py            (Mean, CLS, Max)
â”‚   â”œâ”€â”€ head.py               (Linear, Transformer, Multi-head)
â”‚   â””â”€â”€ classifier.py
â”‚
â”œâ”€â”€ configs/              â† å¤šå€‹é…ç½®æ–‡ä»¶ï¼ˆå³æ’å³ç”¨ï¼‰
â”‚   â”œâ”€â”€ metagene_bpe.yaml
â”‚   â”œâ”€â”€ dnabert_kmer.yaml
â”‚   â””â”€â”€ evo2_nucleotide.yaml
â”‚
â”œâ”€â”€ train.py              â† çµ±ä¸€è¨“ç·´ä»‹é¢
â”œâ”€â”€ predict.py            â† çµ±ä¸€é æ¸¬ä»‹é¢
â””â”€â”€ aggregate.py          â† æ¨£æœ¬å±¤ç´šèšåˆ
```

**å„ªå‹¢ï¼š**
- âœ… **æ¨¡å¡ŠåŒ–è¨­è¨ˆ** - çµ„ä»¶å¯æ›¿æ›
- âœ… **é…ç½®é©…å‹•** - åªéœ€æ”¹ YAMLï¼Œç„¡éœ€æ”¹ä»£ç¢¼
- âœ… **æ˜“æ–¼æ“´å±•** - æ·»åŠ æ–°æ¨¡å‹å¾ˆå®¹æ˜“
- âœ… **æ¨£æœ¬èšåˆ** - è‡ªå‹•è¨ˆç®—ç›¸å°è±åº¦
- âœ… **å¤šæ¨¡å‹æ”¯æŒ** - METAGENE-1, DNABERT, Evo2

---

## ğŸ”„ ä½¿ç”¨å·®ç•°å°æ¯”

### **å ´æ™¯ 1: åŸºæœ¬è¨“ç·´**

#### ç¾æœ‰ç³»çµ±ï¼š
```bash
python train.py \
  --train_set_path /path/to/train \
  --validation_set_path /path/to/val \
  --mapping_df /path/to/mapping.tsv \
  --batch_size 1 \
  --max_epochs 10
```

#### MetaClassifierï¼š
```bash
python metaclassifier/train.py \
  --config metaclassifier/configs/metagene_bpe.yaml \
  --train_fasta /path/to/train \
  --val_fasta /path/to/val \
  --mapping_tsv /path/to/mapping.tsv \
  --output_dir outputs/my_training
```

**å·®ç•°ï¼š** MetaClassifier ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼Œæ›´æ¸…æ™°ï¼

---

### **å ´æ™¯ 2: æ›ç”¨ä¸åŒçš„ Tokenizer**

#### ç¾æœ‰ç³»çµ±ï¼š
```python
# âŒ éœ€è¦ä¿®æ”¹ modeling.py ä»£ç¢¼
# âŒ éœ€è¦æ‰‹å‹•è™•ç† tokenizer é‚è¼¯
# âŒ é›£ä»¥ç¶­è­·
```

#### MetaClassifierï¼š
```yaml
# âœ… åªéœ€ä¿®æ”¹é…ç½®æ–‡ä»¶
tokenizer:
  type: kmer           # å¾ bpe æ”¹æˆ kmer
  k: 6
  overlap: true
```

**å·®ç•°ï¼š** MetaClassifier åªéœ€æ”¹é…ç½®ï¼Œç„¡éœ€æ”¹ä»£ç¢¼ï¼

---

### **å ´æ™¯ 3: ä½¿ç”¨ä¸åŒçš„åŸºç¤æ¨¡å‹**

#### ç¾æœ‰ç³»çµ±ï¼š
```python
# âŒ éœ€è¦é‡å¯« modeling.py
# âŒ éœ€è¦æ‰‹å‹•è™•ç† encoder åŠ è¼‰
# âŒ éœ€è¦èª¿æ•´æ•¸æ“šè™•ç†æµç¨‹
```

#### MetaClassifierï¼š
```yaml
# âœ… åªéœ€ä¿®æ”¹é…ç½®æ–‡ä»¶
encoder:
  type: dnabert       # å¾ metagene æ”¹æˆ dnabert
  path: "zhihan1996/DNABERT-2-117M"
```

é…åˆï¼š
```yaml
tokenizer:
  type: kmer          # é…åˆ DNABERT ä½¿ç”¨ k-mer
  k: 6
```

**å·®ç•°ï¼š** MetaClassifier è‡ªå‹•è™•ç†ä¸åŒæ¨¡å‹ï¼

---

### **å ´æ™¯ 4: é æ¸¬ + æ¨£æœ¬èšåˆ**

#### ç¾æœ‰ç³»çµ±ï¼š
```bash
# Step 1: é æ¸¬
python predict.py --input reads.fasta --output predictions.csv

# Step 2: æ‰‹å‹•å¯«è…³æœ¬é€²è¡Œèšåˆ
# âŒ éœ€è¦è‡ªå·±å¯«ä»£ç¢¼è¨ˆç®—ç›¸å°è±åº¦
# âŒ éœ€è¦è‡ªå·±è™•ç† sample_id
```

#### MetaClassifierï¼š
```bash
# ä¸€æ­¥å®Œæˆé æ¸¬ + èšåˆ
python metaclassifier/predict.py \
  --config metaclassifier/configs/metagene_bpe.yaml \
  --checkpoint outputs/best.pt \
  --input reads.fasta \
  --output predictions.csv \
  --aggregate \
  --abundance_output abundance.csv
```

**è¼¸å‡ºï¼š**
- `predictions.csv` - æ¯æ¢è®€çš„é æ¸¬
- `abundance.csv` - æ¯å€‹æ¨£æœ¬çš„ç›¸å°è±åº¦
- `diversity_metrics.csv` - Shannon/Simpson æŒ‡æ•¸

**å·®ç•°ï¼š** MetaClassifier è‡ªå‹•èšåˆï¼Œç„¡éœ€æ‰‹å‹•ç·¨ç¢¼ï¼

---

## ğŸ¯ ä½•æ™‚ä½¿ç”¨å“ªå€‹ç³»çµ±

### **ä½¿ç”¨ç¾æœ‰ç³»çµ± (classification/train.py)**

é©åˆæƒ…æ³ï¼š
- âœ… åªç”¨ METAGENE-1
- âœ… ä¸éœ€è¦æ›æ¨¡å‹
- âœ… ä¸éœ€è¦èšåˆåŠŸèƒ½
- âœ… å·²ç¶“ç†Ÿæ‚‰ç¾æœ‰æµç¨‹

**å„ªé»ï¼š** ç°¡å–®ç›´æ¥ï¼Œå·²ç¶“æ¸¬è©¦é

---

### **ä½¿ç”¨ MetaClassifier (metaclassifier/)**

é©åˆæƒ…æ³ï¼š
- âœ… æƒ³å˜—è©¦ä¸åŒçš„ tokenizerï¼ˆBPE, k-mer, single-nucleotideï¼‰
- âœ… æƒ³å˜—è©¦ä¸åŒçš„åŸºç¤æ¨¡å‹ï¼ˆMETAGENE-1, DNABERT, Evo2ï¼‰
- âœ… éœ€è¦æ¨£æœ¬å±¤ç´šçš„ç›¸å°è±åº¦åˆ†æ
- âœ… æƒ³è¦æ›´æ¨¡å¡ŠåŒ–ã€å¯æ“´å±•çš„ç³»çµ±
- âœ… ç ”ç©¶å°å‘ï¼Œéœ€è¦æ¯”è¼ƒä¸åŒæ–¹æ³•

**å„ªé»ï¼š** éˆæ´»ã€å¯æ“´å±•ã€åŠŸèƒ½æ›´å®Œæ•´

---

## ğŸ“ ä¿®æ”¹æ¸…å–®å°æ¯”

### **ç¾æœ‰ç³»çµ±éœ€è¦ä¿®æ”¹çš„åœ°æ–¹ï¼š**

1. **train.py å‘½ä»¤è¡Œåƒæ•¸ï¼š**
   ```bash
   --train_set_path
   --validation_set_path
   --mapping_df
   --batch_size
   --max_epochs
   --learning_rate
   ```

2. **å¯é¸ä¿®æ”¹ï¼š**
   - `configs/default.yaml` - èª¿æ•´è¶…åƒæ•¸
   - `modules/modeling.py` - å¦‚æœéœ€è¦æ”¹æ¨¡å‹æ¶æ§‹

---

### **MetaClassifier éœ€è¦ä¿®æ”¹çš„åœ°æ–¹ï¼š**

1. **é¸æ“‡é…ç½®æ–‡ä»¶ï¼š**
   ```bash
   configs/metagene_bpe.yaml      # æˆ–
   configs/dnabert_kmer.yaml      # æˆ–
   configs/evo2_nucleotide.yaml
   ```

2. **ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„ï¼š**
   ```yaml
   dataset:
     train_fasta: /your/path/train
     val_fasta: /your/path/val
     mapping_tsv: /your/path/mapping.tsv
   
   tokenizer:
     max_length: 192              # æ ¹æ“šè®€é•·èª¿æ•´
   
   training:
     output_dir: outputs/my_run   # è¼¸å‡ºç›®éŒ„
   ```

3. **å¯é¸ä¿®æ”¹ï¼š**
   ```yaml
   tokenizer:
     type: bpe/kmer/evo2          # æ› tokenizer
   
   encoder:
     type: metagene/dnabert/evo2  # æ› encoder
     lora:
       r: 4                        # èª¿æ•´ LoRA
   
   model:
     classifier_type: linear/transformer  # æ›åˆ†é¡å™¨
   ```

---

## ğŸš€ æ¨è–¦æµç¨‹

### **åˆå­¸è€… / å¿«é€Ÿé–‹å§‹ï¼š**

**ä½¿ç”¨ç¾æœ‰ç³»çµ±** (`train.py`)
- ç°¡å–®ç›´æ¥
- å·²æ¸¬è©¦ç©©å®š
- å¿«é€Ÿä¸Šæ‰‹

```bash
python train.py \
  --train_set_path /path/to/train \
  --validation_set_path /path/to/val \
  --mapping_df /path/to/mapping.tsv
```

---

### **é€²éšä½¿ç”¨ / ç ”ç©¶å°å‘ï¼š**

**ä½¿ç”¨ MetaClassifier** (`metaclassifier/train.py`)
- æ›´éˆæ´»
- å¯å˜—è©¦å¤šç¨®é…ç½®
- åŠŸèƒ½æ›´å®Œæ•´

```bash
# Step 1: è¤‡è£½ä¸¦ä¿®æ”¹é…ç½®
cp metaclassifier/configs/metagene_bpe.yaml \
   metaclassifier/configs/my_config.yaml

# Step 2: ç·¨è¼¯ my_config.yamlï¼ˆä¿®æ”¹æ•¸æ“šè·¯å¾‘ç­‰ï¼‰

# Step 3: è¨“ç·´
python metaclassifier/train.py \
  --config metaclassifier/configs/my_config.yaml
```

---

## ğŸ“Š æ€§èƒ½å°æ¯”

| ç‰¹æ€§ | ç¾æœ‰ç³»çµ± | MetaClassifier |
|------|----------|----------------|
| **è¨“ç·´é€Ÿåº¦** | ç›¸åŒ | ç›¸åŒ |
| **æ¨¡å‹ç²¾åº¦** | ç›¸åŒ | ç›¸åŒ |
| **ä»£ç¢¼è¤‡é›œåº¦** | ä½ | ä¸­ |
| **éˆæ´»æ€§** | ä½ | **é«˜** |
| **å¯æ“´å±•æ€§** | ä½ | **é«˜** |
| **åŠŸèƒ½å®Œæ•´æ€§** | åŸºç¤ | **å®Œæ•´** |
| **å­¸ç¿’æ›²ç·š** | å¹³ç·© | ç¨é™¡ |

---

## ğŸ’¡ ç¸½çµ

### **ç¾æœ‰ç³»çµ± = å¯¦ç”¨å·¥å…·**
- å¿«é€Ÿã€ç°¡å–®ã€ç©©å®š
- é©åˆç”Ÿç”¢ç’°å¢ƒ
- å°ˆæ³¨æ–¼ METAGENE-1

### **MetaClassifier = ç ”ç©¶æ¡†æ¶**
- éˆæ´»ã€å¯æ“´å±•ã€åŠŸèƒ½å®Œæ•´
- é©åˆç ”ç©¶å’Œå¯¦é©—
- æ”¯æŒå¤šç¨®æ¨¡å‹å’Œæ–¹æ³•

**å»ºè­°ï¼š**
- å¦‚æœåªæ˜¯**ä½¿ç”¨ METAGENE-1 åšåˆ†é¡** â†’ ç”¨ç¾æœ‰ç³»çµ±
- å¦‚æœéœ€è¦**æ¯”è¼ƒä¸åŒæ–¹æ³•ã€é€²è¡Œç ”ç©¶** â†’ ç”¨ MetaClassifier
- å¯ä»¥**å…©è€…ä¸¦ç”¨**ï¼Œæ ¹æ“šéœ€æ±‚é¸æ“‡ï¼

