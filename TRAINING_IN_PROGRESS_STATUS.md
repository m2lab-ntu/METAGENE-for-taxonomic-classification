# è¨“ç·´é€²è¡Œä¸­ç‹€æ…‹å ±å‘Š - 2025-11-19

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ•¸æ“šå­é›†å‰µå»ºæˆåŠŸ
- **è¨“ç·´é›†**: `train_10k_per_species.fa`
  - å¤§å°: 6.3 GB  
  - åºåˆ—æ•¸: 34,980,000  
  - æ¯ç‰©ç¨®: 10,000 æ¢  
  - ç‰©ç¨®æ•¸: 3,498

- **é©—è­‰é›†**: `val_2k_per_species.fa`
  - å¤§å°: 1.3 GB  
  - åºåˆ—æ•¸: 6,996,000  
  - æ¯ç‰©ç¨®: 2,000 æ¢  
  - ç‰©ç¨®æ•¸: 3,498

### 2. è¨“ç·´å·²å•Ÿå‹•
- **æ¨¡å‹**: METAGENE + BPE
- **é…ç½®**: `metaclassifier/configs/metagene_bpe.yaml`
- **å•Ÿå‹•æ™‚é–“**: 2025-11-19 18:14
- **å·²é‹è¡Œ**: ç´„ 5.5 å°æ™‚
- **é€²åº¦**: 82,000 / 34,980,000 (0.23%)

## âš ï¸ ç•¶å‰å•é¡Œ

### å•é¡Œ 1: å¤šå€‹è¨“ç·´é€²ç¨‹
æœ‰ **5 å€‹è¨“ç·´é€²ç¨‹**åŒæ™‚é‹è¡Œï¼Œé€™å¯èƒ½å°è‡´ï¼š
- GPU å…§å­˜ç«¶çˆ­
- è¨“ç·´é€Ÿåº¦è®Šæ…¢
- è³‡æºæµªè²»

**é€²ç¨‹åˆ—è¡¨**:
```
PID: 2170899 (ä¸»é€²ç¨‹ï¼Œé‹è¡Œ 5.5 å°æ™‚)
PID: 2825128 (num_workers[0])
PID: 2825195 (num_workers[1])
PID: 2825227 (num_workers[2])
PID: 2825255 (num_workers[3])
```

### å•é¡Œ 2: è¨“ç·´é€Ÿåº¦å¤ªæ…¢
- **ç•¶å‰é€Ÿåº¦**: ~7-8 it/s
- **batch_size**: 1 (å¤ªå°ï¼)
- **é è¨ˆç¸½æ™‚é–“**: è¶…é 1000 å°æ™‚ âŒ

**åŸå› **:
1. batch_size=1 å¤ªå°ï¼Œç„¡æ³•å……åˆ†åˆ©ç”¨ GPU
2. grad_accum_steps=8 å°è‡´æ¯8æ­¥æ‰æ›´æ–°ä¸€æ¬¡
3. IndexedFastaDataset æ¯æ¬¡å¾æ–‡ä»¶è®€å–åºåˆ—ï¼ˆI/O ç“¶é ¸ï¼‰

### å•é¡Œ 3: ç´¢å¼•å»ºç«‹æ™‚å…§å­˜æ¶ˆè€—
- IndexedFastaDataset ä»ç„¶éœ€è¦å»ºç«‹ç´¢å¼•
- é›–ç„¶ä¸è¼‰å…¥æ‰€æœ‰åºåˆ—ï¼Œä½†ç´¢å¼•æœ¬èº«ä¹Ÿéœ€è¦å…§å­˜

## ğŸ”§ è§£æ±ºæ–¹æ¡ˆ

### æ–¹æ¡ˆ A: å„ªåŒ–ç•¶å‰è¨“ç·´é…ç½® (æ¨è–¦)

åœæ­¢ç•¶å‰è¨“ç·´ä¸¦ä½¿ç”¨å„ªåŒ–é…ç½®é‡æ–°å•Ÿå‹•ï¼š

#### 1. ä¿®æ”¹é…ç½®æ–‡ä»¶
ä¿®æ”¹ `metaclassifier/configs/metagene_bpe.yaml`:

```yaml
training:
  batch_size: 8          # å¾ 1 æ”¹ç‚º 8
  grad_accum_steps: 2    # å¾ 8 æ”¹ç‚º 2 (æœ‰æ•ˆ batch=16)
  max_epochs: 5
  lr: 0.0002
  weight_decay: 0.01
```

#### 2. ä¿®æ”¹ train.py çš„ DataLoader
åœ¨ `train.py` ä¸­ï¼š

```python
train_loader = DataLoader(
    train_dataset,
    batch_size=config['training']['batch_size'],
    shuffle=True,
    num_workers=2,  # å¾ 4 æ”¹ç‚º 2ï¼Œæ¸›å°‘é€²ç¨‹æ•¸
    pin_memory=True
)
```

#### 3. é è¨ˆæ”¹å–„
- é€Ÿåº¦: å¾ ~8 it/s æå‡åˆ° ~50-100 it/s
- è¨“ç·´æ™‚é–“: å¾ >1000 å°æ™‚é™ä½åˆ° **~50-100 å°æ™‚**
- ä»ç„¶å¤ªæ…¢... ğŸ˜Ÿ

### æ–¹æ¡ˆ B: ä½¿ç”¨åŸå§‹ SequenceDataset + æ›´å°æ•¸æ“šå­é›† (æ¨è–¦) â­

å•é¡Œæ ¹æºï¼šIndexedFastaDataset é›–ç„¶ç¯€çœå…§å­˜ï¼Œä½†æ¯æ¬¡éƒ½è¦å¾æ–‡ä»¶è®€å–ï¼ŒI/O æˆç‚ºç“¶é ¸ã€‚

**æ›´å¥½çš„æ–¹æ¡ˆ**:
1. å‰µå»º**æ›´å°çš„è¨“ç·´å­é›†** (ä¾‹å¦‚æ¯ç‰©ç¨® 1000-2000 æ¢)
2. ä½¿ç”¨åŸå§‹çš„ `SequenceDataset` (ä¸€æ¬¡æ€§è¼‰å…¥åˆ°å…§å­˜)
3. é€™æ¨£å¯ä»¥å¿«é€Ÿè¿­ä»£ï¼Œé€Ÿåº¦å¿« 10-100 å€ï¼

**å‰µå»ºå°è¦æ¨¡å­é›†**:
```bash
cd /media/user/disk2/METAGENE/classification

# å‰µå»ºæ›´å°çš„è¨“ç·´é›† (æ¯ç‰©ç¨® 2000 æ¢)
python3 -u create_training_subset.py \
  -i training_data_subsets/train_10k_per_species.fa \
  -o training_data_subsets/train_2k_per_species.fa \
  -n 2000

# å‰µå»ºæ›´å°çš„é©—è­‰é›† (æ¯ç‰©ç¨® 400 æ¢)
python3 -u create_training_subset.py \
  -i training_data_subsets/val_2k_per_species.fa \
  -o training_data_subsets/val_400_per_species.fa \
  -n 400
```

**é è¨ˆæ•ˆæœ**:
- è¨“ç·´é›†: ~7M åºåˆ— (~1.3 GB)
- é©—è­‰é›†: ~1.4M åºåˆ— (~260 MB)
- è¼‰å…¥æ™‚é–“: < 5 åˆ†é˜
- è¨“ç·´é€Ÿåº¦: ~50-200 it/s
- **æ¯å€‹ epoch**: ~10-20 å°æ™‚
- **5 epochs**: **~50-100 å°æ™‚** âœ…

### æ–¹æ¡ˆ C: è½‰æ›ç‚ºå…§å­˜å‹å¥½æ ¼å¼

å°‡ FASTA è½‰æ›ç‚º HDF5/NPZ æ ¼å¼ï¼š
- ä¸€æ¬¡æ€§è½‰æ›
- è¨“ç·´æ™‚æ¥µå¿«è¼‰å…¥
- ä½†éœ€è¦é¡å¤–æ™‚é–“å’Œç©ºé–“

## ğŸ“‹ ç«‹å³è¡Œå‹•æ­¥é©Ÿ

### é¸é … 1: å¿«é€Ÿé©—è­‰æµç¨‹ (æ¨è–¦) â­

```bash
# 1. åœæ­¢ç•¶å‰è¨“ç·´
pkill -f "train.py"

# 2. å‰µå»ºå°è¦æ¨¡å­é›†
cd /media/user/disk2/METAGENE/classification

nohup python3 -u create_training_subset.py \
  -i training_data_subsets/train_10k_per_species.fa \
  -o training_data_subsets/train_2k_per_species.fa \
  -n 2000 > create_2k_subset.log 2>&1 &

# 3. ç­‰å¾…å®Œæˆå¾Œä¿®æ”¹è¨“ç·´è…³æœ¬
# ç·¨è¼¯ train_benchmark_2models.sh:
TRAIN_FASTA=".../train_2k_per_species.fa"
VAL_FASTA=".../val_400_per_species.fa"

# 4. ä¿®æ”¹ train.py æ¢å¾©ä½¿ç”¨ SequenceDataset
# (ä¸ä½¿ç”¨ IndexedFastaDataset)

# 5. é‡æ–°å•Ÿå‹•è¨“ç·´
./train_benchmark_2models.sh
```

### é¸é … 2: ç¹¼çºŒç•¶å‰è¨“ç·´ä¸¦å„ªåŒ–

å¦‚æœæ‚¨æƒ³ä¿ç•™ç•¶å‰é€²åº¦ï¼ˆé›–ç„¶åªæœ‰ 0.23%ï¼‰ï¼Œå¯ä»¥ï¼š
1. ä¿®æ”¹é…ç½®å¢åŠ  batch_size
2. æ¸›å°‘ num_workers
3. ä½†é€Ÿåº¦ä»æœƒå— I/O é™åˆ¶

## ğŸ’¡ å»ºè­°æ±ºç­–

**æˆ‘çš„å¼·çƒˆå»ºè­°**: 

æ¡ç”¨**æ–¹æ¡ˆ B + é¸é … 1** - å‰µå»ºå°è¦æ¨¡å­é›†ä¸¦ä½¿ç”¨åŸå§‹ SequenceDataset

**ç†ç”±**:
1. âœ… å¿«é€Ÿé©—è­‰æ•´å€‹æµç¨‹ (50-100 å°æ™‚ vs >1000 å°æ™‚)
2. âœ… ä»æœ‰è¶³å¤ æ•¸æ“šé‡ (æ¯ç‰©ç¨® 2000 æ¢)
3. âœ… é¿å… I/O ç“¶é ¸
4. âœ… å¯ä»¥å¿«é€Ÿè¿­ä»£å’Œèª¿è©¦
5. âœ… å®Œæˆå¾Œå¯ä»¥æ ¹æ“šéœ€è¦æ“´å±•åˆ°æ›´å¤§æ•¸æ“šé›†

## ğŸ“Š æ•¸æ“šè¦æ¨¡å°æ¯”

| æ•¸æ“šé›† | æ¯ç‰©ç¨®åºåˆ—æ•¸ | ç¸½åºåˆ—æ•¸ | å¤§å° | è¼‰å…¥æ™‚é–“ | è¨“ç·´é€Ÿåº¦ | æ¯epochæ™‚é–“ |
|--------|-------------|---------|------|---------|----------|------------|
| å®Œæ•´ (100GB) | ~160K | 558M | 100GB | æ•¸å°æ™‚ | N/A | N/A |
| å¤§è¦æ¨¡ | 10K | 35M | 6.3GB | æ•¸å°æ™‚(ç´¢å¼•) | ~8 it/s | >100h |
| ä¸­è¦æ¨¡ â­ | 2K | 7M | 1.3GB | < 5åˆ†é˜ | ~100 it/s | 10-20h |
| å°è¦æ¨¡ | 1K | 3.5M | 650MB | < 2åˆ†é˜ | ~150 it/s | 5-10h |

## ğŸ¯ ä¸‹ä¸€æ­¥

ç­‰å¾…æ‚¨çš„æ±ºå®šï¼š
- [ ] ç¹¼çºŒç•¶å‰è¨“ç·´ï¼ˆé è¨ˆ >1000 å°æ™‚ï¼‰
- [ ] åœæ­¢ä¸¦å‰µå»ºå°è¦æ¨¡å­é›†ï¼ˆæ¨è–¦ï¼Œé è¨ˆ 50-100 å°æ™‚ï¼‰
- [ ] åœæ­¢ä¸¦å„ªåŒ–ç•¶å‰é…ç½®

## é™„éŒ„ï¼šç›£æ§å‘½ä»¤

```bash
# æŸ¥çœ‹è¨“ç·´é€²åº¦
tail -f train_benchmark_subset.log

# æª¢æŸ¥ GPU ä½¿ç”¨
nvidia-smi

# æª¢æŸ¥è¨“ç·´é€²ç¨‹
ps aux | grep train.py | grep -v grep

# åœæ­¢è¨“ç·´
pkill -f "train.py"

# æŸ¥çœ‹è¼¸å‡ºç›®éŒ„
ls -lh outputs/benchmark_metagene_bpe_*/
```

