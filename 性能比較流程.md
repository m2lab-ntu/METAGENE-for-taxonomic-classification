# æ€§èƒ½æ¯”è¼ƒæµç¨‹ (Performance Benchmark Pipeline)

å®Œæ•´çš„æ¨™æº–åŒ–æ€§èƒ½è©•ä¼°å’Œæ¯”è¼ƒæµç¨‹

---

## ðŸ“‹ æµç¨‹æ¦‚è¦½

```
full_labeled_species_sequences (æºæ•¸æ“š)
            â†“
    [Step 1] å‰µå»ºæ¸¬è©¦é›†
            â†“
       test.fa (ç¨ç«‹æ¸¬è©¦é›†)
            â†“
    [Step 2] è¨“ç·´å¤šå€‹æ–¹æ³•
            â†“
    method_1.pt, method_2.pt, ...
            â†“
    [Step 3] é‹è¡Œbenchmark
            â†“
    æ€§èƒ½æ¯”è¼ƒå ±å‘Š
```

---

## ðŸŽ¯ Step 1: å‰µå»ºæ¸¬è©¦æ•¸æ“šé›†

### **ç›®æ¨™**
å¾ž `full_labeled_species_sequences` å‰µå»ºç¨ç«‹çš„æ¸¬è©¦é›†ï¼Œ**ç¢ºä¿èˆ‡è¨“ç·´/é©—è­‰é›†ä¸é‡ç–Š**

### **åŸ·è¡Œå‘½ä»¤**

#### **é¸é … A: å°åž‹æ¸¬è©¦é›†ï¼ˆå¿«é€Ÿé©—è­‰ï¼‰**

```bash
python create_test_dataset.py \
  --source_dir /media/user/disk2/full_labeled_species_sequences \
  --output test_data/test_small.fa \
  --train_dir /media/user/disk2/full_labeled_species_train_reads_shuffled \
  --val_dir /media/user/disk2/full_labeled_species_val_reads_shuffled \
  --reads_per_species 50 \
  --max_species 100 \
  --seed 42
```

**ç‰¹é»žï¼š**
- æ¯å€‹ç‰©ç¨® 50 æ¢è®€
- æœ€å¤š 100 å€‹ç‰©ç¨®
- ç´„ 5,000 æ¢è®€
- **ç”¨æ™‚**: ~5-10 åˆ†é˜

---

#### **é¸é … B: ä¸­åž‹æ¸¬è©¦é›†ï¼ˆæŽ¨è–¦ï¼‰** âœ…

```bash
python create_test_dataset.py \
  --source_dir /media/user/disk2/full_labeled_species_sequences \
  --output test_data/test_medium.fa \
  --train_dir /media/user/disk2/full_labeled_species_train_reads_shuffled \
  --val_dir /media/user/disk2/full_labeled_species_val_reads_shuffled \
  --reads_per_species 100 \
  --max_species 500 \
  --seed 42
```

**ç‰¹é»žï¼š**
- æ¯å€‹ç‰©ç¨® 100 æ¢è®€
- æœ€å¤š 500 å€‹ç‰©ç¨®
- ç´„ 50,000 æ¢è®€
- **ç”¨æ™‚**: ~30-60 åˆ†é˜

---

#### **é¸é … C: å®Œæ•´æ¸¬è©¦é›†ï¼ˆå…¨é¢è©•ä¼°ï¼‰**

```bash
python create_test_dataset.py \
  --source_dir /media/user/disk2/full_labeled_species_sequences \
  --output test_data/test_full.fa \
  --train_dir /media/user/disk2/full_labeled_species_train_reads_shuffled \
  --val_dir /media/user/disk2/full_labeled_species_val_reads_shuffled \
  --reads_per_species 200 \
  --seed 42
```

**ç‰¹é»žï¼š**
- æ¯å€‹ç‰©ç¨® 200 æ¢è®€
- æ‰€æœ‰å¯ç”¨ç‰©ç¨®
- ç´„ 700,000 æ¢è®€
- **ç”¨æ™‚**: ~2-3 å°æ™‚

---

### **è¼¸å‡º**

```
test_data/
â”œâ”€â”€ test_medium.fa           # æ¸¬è©¦æ•¸æ“šï¼ˆFASTA æ ¼å¼ï¼‰
â””â”€â”€ test_medium_stats.txt    # çµ±è¨ˆä¿¡æ¯
```

**test_medium_stats.txt å…§å®¹ç¤ºä¾‹ï¼š**
```
æ¸¬è©¦æ•¸æ“šé›†çµ±è¨ˆä¿¡æ¯
============================================================

ç¸½åºåˆ—æ•¸: 50,000
ç‰©ç¨®æ•¸: 500
éŽæ¿¾åºåˆ— (é•·åº¦): 1,234
éŽæ¿¾åºåˆ— (é‡ç–Š): 2,567
å¹³å‡æ¯ç‰©ç¨®: 100.0

æ¯å€‹ç‰©ç¨®çš„è©³ç´°çµ±è¨ˆ:
------------------------------------------------------------
100174: 100/1500 (éŽæ¿¾: 20, é‡ç–Š: 50)
100225: 100/2000 (éŽæ¿¾: 15, é‡ç–Š: 30)
...
```

---

## ðŸ”¬ Step 2: è¨“ç·´ä¸åŒæ–¹æ³•

### **æ–¹æ³•åˆ—è¡¨ç¤ºä¾‹**

| æ–¹æ³•å | Tokenizer | Encoder | Classifier | é…ç½®æ–‡ä»¶ |
|--------|-----------|---------|------------|----------|
| METAGENE_BPE | BPE | METAGENE-1 | Linear | metagene_bpe.yaml |
| METAGENE_KMER | K-mer | METAGENE-1 | Linear | metagene_kmer.yaml |
| DNABERT_KMER | K-mer | DNABERT-2 | Linear | dnabert_kmer.yaml |
| METAGENE_TRANSFORMER | BPE | METAGENE-1 | Transformer | metagene_transformer.yaml |

### **è¨“ç·´æ¯å€‹æ–¹æ³•**

#### **æ–¹æ³• 1: METAGENE + BPE (Baseline)**

```bash
# ä½¿ç”¨ç¾æœ‰ç³»çµ±
python train.py \
  --train_set_path /media/user/disk2/full_labeled_species_train_reads_shuffled \
  --validation_set_path /media/user/disk2/full_labeled_species_val_reads_shuffled \
  --mapping_df /media/user/disk2/MetaTransformer_new_pipeline/myScript/all_available_species_mapping.tab \
  --output_dir outputs/method_metagene_bpe \
  --batch_size 1 \
  --max_epochs 5
```

#### **æ–¹æ³• 2: METAGENE + K-mer**

```bash
# ä½¿ç”¨ MetaClassifier
python metaclassifier/train.py \
  --config metaclassifier/configs/metagene_kmer.yaml \
  --train_fasta /media/user/disk2/full_labeled_species_train_reads_shuffled \
  --val_fasta /media/user/disk2/full_labeled_species_val_reads_shuffled \
  --mapping_tsv /media/user/disk2/MetaTransformer_new_pipeline/myScript/all_available_species_mapping.tab \
  --output_dir outputs/method_metagene_kmer
```

#### **æ–¹æ³• 3: DNABERT + K-mer**

```bash
python metaclassifier/train.py \
  --config metaclassifier/configs/dnabert_kmer.yaml \
  --train_fasta /media/user/disk2/full_labeled_species_train_reads_shuffled \
  --val_fasta /media/user/disk2/full_labeled_species_val_reads_shuffled \
  --mapping_tsv /media/user/disk2/MetaTransformer_new_pipeline/myScript/all_available_species_mapping.tab \
  --output_dir outputs/method_dnabert_kmer
```

**è¨“ç·´å¾Œæœƒå¾—åˆ°ï¼š**
```
outputs/
â”œâ”€â”€ method_metagene_bpe/
â”‚   â””â”€â”€ checkpoints/
â”‚       â””â”€â”€ best.pt
â”œâ”€â”€ method_metagene_kmer/
â”‚   â””â”€â”€ checkpoints/
â”‚       â””â”€â”€ best.pt
â””â”€â”€ method_dnabert_kmer/
    â””â”€â”€ checkpoints/
        â””â”€â”€ best.pt
```

---

## ðŸ“Š Step 3: é‹è¡Œæ€§èƒ½æ¯”è¼ƒ

### **3.1 å‰µå»ºæ–¹æ³•é…ç½®æ–‡ä»¶**

å‰µå»º `methods_config.json`ï¼š

```json
[
  {
    "name": "METAGENE_BPE_Baseline",
    "checkpoint": "outputs/method_metagene_bpe/checkpoints/best.pt",
    "config": null,
    "description": "METAGENE-1 with BPE tokenizer (baseline)"
  },
  {
    "name": "METAGENE_KMER",
    "checkpoint": "outputs/method_metagene_kmer/checkpoints/best.pt",
    "config": "metaclassifier/configs/metagene_kmer.yaml",
    "description": "METAGENE-1 with k-mer tokenizer"
  },
  {
    "name": "DNABERT_KMER",
    "checkpoint": "outputs/method_dnabert_kmer/checkpoints/best.pt",
    "config": "metaclassifier/configs/dnabert_kmer.yaml",
    "description": "DNABERT-2 with k-mer tokenizer"
  }
]
```

### **3.2 é‹è¡Œ Benchmark**

```bash
python benchmark_framework.py \
  --test_data test_data/test_medium.fa \
  --mapping_tsv species_mapping_converted.tsv \
  --output_dir benchmark_results \
  --methods methods_config.json
```

### **3.3 è¼¸å‡ºçµæžœ**

```
benchmark_results/
â”œâ”€â”€ predictions_METAGENE_BPE_Baseline.csv    # å„æ–¹æ³•çš„é æ¸¬çµæžœ
â”œâ”€â”€ predictions_METAGENE_KMER.csv
â”œâ”€â”€ predictions_DNABERT_KMER.csv
â”œâ”€â”€ benchmark_comparison.csv                  # æ–¹æ³•æ¯”è¼ƒè¡¨
â”œâ”€â”€ benchmark_report_20251110_120000.md      # è©³ç´°å ±å‘Š
â””â”€â”€ benchmark_report_20251110_120000.json    # JSON æ ¼å¼çµæžœ
```

**benchmark_comparison.csv ç¤ºä¾‹ï¼š**
```csv
Method,Accuracy,Macro Accuracy,Weighted Accuracy,Avg Confidence,Num Classes,Total Samples
METAGENE_BPE_Baseline,0.8523,0.8234,0.8456,0.7845,500,50000
METAGENE_KMER,0.8312,0.8045,0.8234,0.7623,500,50000
DNABERT_KMER,0.8678,0.8456,0.8589,0.8012,500,50000
```

---

## ðŸ“ˆ Step 4: åˆ†æžçµæžœ

### **4.1 æŸ¥çœ‹å ±å‘Š**

```bash
# æŸ¥çœ‹ Markdown å ±å‘Š
cat benchmark_results/benchmark_report_*.md

# æŸ¥çœ‹ JSON çµæžœï¼ˆè©³ç´°ï¼‰
cat benchmark_results/benchmark_report_*.json | jq '.'
```

### **4.2 æ¯”è¼ƒè¡¨æ ¼**

```bash
# æŸ¥çœ‹æ¯”è¼ƒè¡¨æ ¼
column -t -s, benchmark_results/benchmark_comparison.csv
```

### **4.3 è¦–è¦ºåŒ–ï¼ˆå¯é¸ï¼‰**

ä½¿ç”¨ Python å‰µå»ºåœ–è¡¨ï¼š

```python
import pandas as pd
import matplotlib.pyplot as plt

# è®€å–çµæžœ
df = pd.read_csv('benchmark_results/benchmark_comparison.csv')

# ç¹ªè£½æº–ç¢ºçŽ‡æ¯”è¼ƒ
plt.figure(figsize=(10, 6))
plt.bar(df['Method'], df['Accuracy'])
plt.xlabel('Method')
plt.ylabel('Accuracy')
plt.title('Method Comparison')
plt.xticks(rotation=45)
plt.tight_layout()
plt.savefig('benchmark_results/accuracy_comparison.png')
```

---

## ðŸŽ¯ å®Œæ•´ç¯„ä¾‹ï¼šå¾žé ­åˆ°å°¾

### **Step-by-Step å®Œæ•´åŸ·è¡Œ**

```bash
# ===== 1. æ¿€æ´»ç’°å¢ƒ =====
source /home/user/anaconda3/bin/activate METAGENE

export HF_HOME=/media/user/disk2/.cache/huggingface
export TRANSFORMERS_CACHE=/media/user/disk2/.cache/huggingface
export PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True,max_split_size_mb:128

cd /media/user/disk2/METAGENE/classification

# ===== 2. å‰µå»ºæ¸¬è©¦é›† =====
python create_test_dataset.py \
  --source_dir /media/user/disk2/full_labeled_species_sequences \
  --output test_data/test_benchmark.fa \
  --train_dir /media/user/disk2/full_labeled_species_train_reads_shuffled \
  --val_dir /media/user/disk2/full_labeled_species_val_reads_shuffled \
  --reads_per_species 100 \
  --max_species 500 \
  --seed 42

# ===== 3. è¨“ç·´æ–¹æ³•ï¼ˆå¦‚æžœé‚„æ²’è¨“ç·´ï¼‰=====
# æ–¹æ³• 1: METAGENE BPE (å·²ç¶“æœ‰äº†ï¼Œè·³éŽ)
# æ–¹æ³• 2: METAGENE KMER
python metaclassifier/train.py \
  --config metaclassifier/configs/metagene_kmer.yaml \
  --output_dir outputs/benchmark_metagene_kmer

# æ–¹æ³• 3: DNABERT KMER
python metaclassifier/train.py \
  --config metaclassifier/configs/dnabert_kmer.yaml \
  --output_dir outputs/benchmark_dnabert_kmer

# ===== 4. å‰µå»ºæ–¹æ³•é…ç½® =====
cat > methods_config.json << 'EOF'
[
  {
    "name": "Current_Training",
    "checkpoint": "outputs/fast_training_20251110_200726/checkpoints/best.pt",
    "config": "configs/fast_training.yaml"
  },
  {
    "name": "METAGENE_KMER",
    "checkpoint": "outputs/benchmark_metagene_kmer/checkpoints/best.pt",
    "config": "metaclassifier/configs/metagene_kmer.yaml"
  }
]
EOF

# ===== 5. é‹è¡Œ Benchmark =====
python benchmark_framework.py \
  --test_data test_data/test_benchmark.fa \
  --mapping_tsv species_mapping_converted.tsv \
  --output_dir benchmark_results \
  --methods methods_config.json

# ===== 6. æŸ¥çœ‹çµæžœ =====
cat benchmark_results/benchmark_comparison.csv
cat benchmark_results/benchmark_report_*.md
```

---

## ðŸ” é€²éšŽä½¿ç”¨

### **æ¯”è¼ƒä¸åŒè¶…åƒæ•¸**

```json
[
  {
    "name": "METAGENE_lr_0.0001",
    "checkpoint": "outputs/metagene_lr_0.0001/best.pt",
    "config": "configs/metagene_lr_0.0001.yaml"
  },
  {
    "name": "METAGENE_lr_0.0002",
    "checkpoint": "outputs/metagene_lr_0.0002/best.pt",
    "config": "configs/metagene_lr_0.0002.yaml"
  },
  {
    "name": "METAGENE_lr_0.0005",
    "checkpoint": "outputs/metagene_lr_0.0005/best.pt",
    "config": "configs/metagene_lr_0.0005.yaml"
  }
]
```

### **æ¯”è¼ƒä¸åŒ max_length**

```json
[
  {
    "name": "MaxLen_128",
    "checkpoint": "outputs/maxlen_128/best.pt",
    "config": "configs/maxlen_128.yaml"
  },
  {
    "name": "MaxLen_192",
    "checkpoint": "outputs/maxlen_192/best.pt",
    "config": "configs/maxlen_192.yaml"
  },
  {
    "name": "MaxLen_256",
    "checkpoint": "outputs/maxlen_256/best.pt",
    "config": "configs/maxlen_256.yaml"
  }
]
```

---

## ðŸ“Š è©•ä¼°æŒ‡æ¨™èªªæ˜Ž

| æŒ‡æ¨™ | èªªæ˜Ž | é©ç”¨å ´æ™¯ |
|------|------|----------|
| **Accuracy** | ç¸½é«”æº–ç¢ºçŽ‡ | å¹³è¡¡æ•¸æ“šé›† |
| **Macro Accuracy** | å®å¹³å‡æº–ç¢ºçŽ‡ï¼ˆæ¯é¡žæ¬Šé‡ç›¸åŒï¼‰ | ä¸å¹³è¡¡æ•¸æ“šé›† |
| **Weighted Accuracy** | åŠ æ¬Šæº–ç¢ºçŽ‡ï¼ˆæŒ‰æ¨£æœ¬æ•¸åŠ æ¬Šï¼‰ | ä¸å¹³è¡¡æ•¸æ“šé›† |
| **Avg Confidence** | å¹³å‡é æ¸¬ç½®ä¿¡åº¦ | æ¨¡åž‹ä¿¡å¿ƒè©•ä¼° |
| **Per-class Accuracy** | æ¯å€‹é¡žåˆ¥çš„æº–ç¢ºçŽ‡ | ç´°ç²’åº¦åˆ†æž |

---

## âš ï¸ æ³¨æ„äº‹é …

### **1. ç¢ºä¿æ¸¬è©¦é›†ç¨ç«‹æ€§**
- âœ… **ä¸€å®šè¦ä½¿ç”¨** `--train_dir` å’Œ `--val_dir` åƒæ•¸
- âœ… æ¸¬è©¦é›†ä¸æ‡‰èˆ‡è¨“ç·´/é©—è­‰é›†é‡ç–Š
- âœ… ä½¿ç”¨ç›¸åŒçš„ `--seed` ç¢ºä¿å¯é‡ç¾æ€§

### **2. æ•¸æ“šå¹³è¡¡æ€§**
- æ¯å€‹ç‰©ç¨®æŽ¡æ¨£ç›¸åŒæ•¸é‡çš„è®€
- å¦‚æžœæŸäº›ç‰©ç¨®æ•¸æ“šä¸è¶³ï¼Œæœƒè‡ªå‹•èª¿æ•´
- æª¢æŸ¥ `_stats.txt` ç¢ºèªæŽ¡æ¨£æƒ…æ³

### **3. è¨ˆç®—è³‡æº**
- å°åž‹æ¸¬è©¦é›†: ~10åˆ†é˜ï¼ˆé æ¸¬ï¼‰
- ä¸­åž‹æ¸¬è©¦é›†: ~1å°æ™‚ï¼ˆé æ¸¬ï¼‰
- å®Œæ•´æ¸¬è©¦é›†: ~4-6å°æ™‚ï¼ˆé æ¸¬ï¼‰

### **4. ç£ç›¤ç©ºé–“**
- æ¸¬è©¦æ•¸æ“š: ~100MB - 2GB
- é æ¸¬çµæžœ: ~50MB - 500MB per method
- ç¸½è¨ˆ: ~1GB - 5GB

---

## ðŸŽ‰ å®Œæˆæª¢æŸ¥æ¸…å–®

- [ ] å‰µå»ºæ¸¬è©¦æ•¸æ“šé›† (`test_data/test_*.fa`)
- [ ] ç¢ºèªæ¸¬è©¦é›†çµ±è¨ˆä¿¡æ¯ (`_stats.txt`)
- [ ] è¨“ç·´æ‰€æœ‰è¦æ¯”è¼ƒçš„æ–¹æ³•
- [ ] å‰µå»ºæ–¹æ³•é…ç½® JSON (`methods_config.json`)
- [ ] é‹è¡Œ benchmark è©•ä¼°
- [ ] æŸ¥çœ‹æ¯”è¼ƒå ±å‘Š (`benchmark_report_*.md`)
- [ ] åˆ†æžçµæžœä¸¦å¾—å‡ºçµè«–

---

## ðŸ“š ç›¸é—œæ–‡æª”

- `create_test_dataset.py` - æ¸¬è©¦é›†å‰µå»ºè…³æœ¬
- `benchmark_framework.py` - æ€§èƒ½æ¯”è¼ƒæ¡†æž¶
- `metaclassifier/é…ç½®ä¿®æ”¹æŒ‡å—.md` - é…ç½®èªªæ˜Ž
- `metaclassifier/ç³»çµ±å°æ¯”èªªæ˜Ž.md` - ç³»çµ±å°æ¯”

---

## ðŸ’¡ æç¤º

1. **å…ˆç”¨å°åž‹æ¸¬è©¦é›†é©—è­‰æµç¨‹**ï¼Œç¢ºèªæ²’å•é¡Œå¾Œå†ç”¨å®Œæ•´æ¸¬è©¦é›†
2. **è¨˜éŒ„æ¯å€‹æ–¹æ³•çš„è¨“ç·´é…ç½®**ï¼Œæ–¹ä¾¿å¾ŒçºŒåˆ†æž
3. **ä¿å­˜æ‰€æœ‰ checkpoint**ï¼Œä»¥ä¾¿é‡æ–°è©•ä¼°
4. **å®šæœŸå‚™ä»½çµæžœ**ï¼Œé¿å…æ„å¤–ä¸Ÿå¤±
5. **ä½¿ç”¨æœ‰æ„ç¾©çš„æ–¹æ³•åç¨±**ï¼Œæ–¹ä¾¿è­˜åˆ¥å’Œæ¯”è¼ƒ

éœ€è¦å¹«åŠ©ï¼ŸæŸ¥çœ‹ `README.md` æˆ–æ issueï¼

